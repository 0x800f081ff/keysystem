<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KeyAuth Admin Panel</title>
<style>
body{font-family:Arial;margin:20px;background:#111;color:#eee;}
h2{margin-top:40px;}
table{border-collapse:collapse;width:100%;margin-bottom:20px;}
th,td{border:1px solid #333;padding:5px;text-align:left;}
input,button{padding:5px;margin:3px;background:#222;color:#fff;border:1px solid #444;border-radius:5px;}
button:hover{background:#333;}
.hidden{display:none;}
</style>
</head>
<body>
<h1>KeyAuth Admin Panel</h1>

<label>Admin Token:</label>
<input type="text" id="adminToken" placeholder="Your admin token">
<button onclick="connectAdmin()">Connect</button>

<div id="adminContent" class="hidden">

<h2>Generate License</h2>
<label>Allowed Uses: <input id="allowedUses" type="number" value="1"></label>
<label>Validity (0 = Lifetime): 
  <input id="timeValid" type="text" placeholder="10s / 10m / 10h / 10d / 10y">
</label>
<button onclick="adminAction('generate')">Generate License</button>

<h2>Existing Licenses</h2>
<div id="licensesTable"></div>

<h2>Users</h2>
<div id="usersTable"></div>

</div>

<script>
let adminToken = '';
let countdownIntervals = {};

async function connectAdmin() {
  adminToken = document.getElementById('adminToken').value.trim();
  if(!adminToken) return alert('Enter admin token');
  try {
    const res = await fetch('/api/admin', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ token: adminToken, action: 'none' })
    });
    const data = await res.json();
    if(data.error) return alert(data.error);
    document.getElementById('adminContent').classList.remove('hidden');
    renderTables(data);
  } catch(err) {
    alert(err);
  }
}

async function adminAction(action, idOrKey=null) {
  let body = { token: adminToken, action };

  if(action === 'generate') {
    body.allowed_uses = document.getElementById('allowedUses').value;
    body.time_valid = document.getElementById('timeValid').value.trim();
  } else if(action.includes('user')) {
    body.user_id = idOrKey;
  } else if(action.includes('key')) {
    body.license_key = idOrKey;
  }

  try {
    const res = await fetch('/api/admin', {
      method:'POST', 
      headers:{'Content-Type':'application/json'}, 
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if(data.msg) alert(data.msg);
    renderTables(data);
  } catch(err) { alert(err); }
}

function renderTables(data) {
  // Clear old countdowns
  Object.values(countdownIntervals).forEach(clearInterval);
  countdownIntervals = {};

  // ---- LICENSES ----
  let html = '<table><tr><th>ID</th><th>Key</th><th>Uses/Allowed</th><th>Email</th><th>Expiry</th><th>Banned</th><th>User</th><th>Actions</th></tr>';
  data.licenses.forEach(l=>{
    const expiryDisplay = formatExpiry(l.expiry);
    html += `<tr>
      <td>${l.id}</td>
      <td>${l.key_code}</td>
      <td>${l.uses}/${l.allowed_uses}</td>
      <td>${l.email || 'N/A'}</td>
      <td id="expiry-${l.id}" data-expiry="${l.expiry_raw || ''}">${expiryDisplay}</td>
      <td>${l.banned}</td>
      <td>${l.user ? l.user.username : 'N/A'}</td>
      <td>
        <button onclick="adminAction('${l.banned? 'unban_key':'ban_key'}','${l.key_code}')">${l.banned? 'Unban':'Ban'}</button>
        <button onclick="adminAction('delete_key','${l.key_code}')">Delete</button>
      </td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('licensesTable').innerHTML = html;

  // ---- USERS ----
  html = '<table><tr><th>ID</th><th>Username</th><th>Email</th><th>Admin</th><th>Banned</th><th>Created</th><th>Last Login</th><th>IP</th><th>Actions</th></tr>';
  data.users.forEach(u=>{
    html += `<tr>
      <td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.email}</td>
      <td>${u.is_admin}</td>
      <td>${u.banned}</td>
      <td>${u.created_at}</td>
      <td>${u.last_login_at || 'N/A'}</td>
      <td>${u.last_login_ip || 'N/A'}</td>
      <td>
        <button onclick="adminAction('${u.banned? 'unban_user':'ban_user'}','${u.id}')">${u.banned? 'Unban':'Ban'}</button>
        <button onclick="adminAction('delete_user','${u.id}')">Delete</button>
      </td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('usersTable').innerHTML = html;

  // Start live countdown for all expiries
  startCountdowns();
}

function formatExpiry(expiry) {
  if (!expiry || expiry === 'Lifetime') return 'Lifetime';
  if (expiry === 'Expired') return 'Expired';
  if (expiry.startsWith('in ')) return expiry;
  return expiry; // fallback
}

// Start all live countdowns
function startCountdowns() {
  const now = Date.now();
  document.querySelectorAll('[id^="expiry-"]').forEach(td => {
    const raw = td.dataset.expiry;
    if (!raw || raw === 'Lifetime' || raw === 'Expired') return;

    const endTime = new Date(raw).getTime();
    if (isNaN(endTime)) return;

    const id = td.id;
    countdownIntervals[id] = setInterval(() => {
      const diff = endTime - Date.now();
      if (diff <= 0) {
        td.textContent = 'Expired';
        clearInterval(countdownIntervals[id]);
        return;
      }
      td.textContent = formatTimeDiff(diff);
    }, 1000);
  });
}

// Format milliseconds to 2d 4h 15m 32s
function formatTimeDiff(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const days = Math.floor(totalSeconds / 86400);
  const hours = Math.floor((totalSeconds % 86400) / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  let parts = [];
  if (days > 0) parts.push(`${days}d`);
  if (hours > 0) parts.push(`${hours}h`);
  if (minutes > 0) parts.push(`${minutes}m`);
  parts.push(`${seconds}s`);
  return 'Expires in ' + parts.join(' ');
}
</script>
</body>
</html>
